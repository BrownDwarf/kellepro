;+
; NAME:
;	TYPE_NIR
;
; PURPOSE:
;	Derive Spectral types based on NIR data
;
; CALLING SEQUENCE:
;	
;	TYPE_NIR, input,file, [/PS, /EPS]
;
;	
; KEYWORD PARAMETERS:
;	PS: Create postscript figures. One per object. 
;		Output file called '[object_name].ps'
;
;   EPS: Create encapsulated postscript figure. 
;		Output file called '[object_name].eps'
;
; OUTPUTS:
;	Plots to screen if no keywords are given.
;	Creates template.ps or template.eps depending on keyword  used.
;
; ROUTINES CALLED:
;	kellepro:colors_kc.pro
;	kellepro:symbols_kc.pro
;	kellepro:symbols_ps_kc.pro
;
; EXAMPLE:
;
;	Plot to screen
;
;		TEMPLATE_FIG
;
;	Create postscript output
;
;		TEMPLATE_FIG, /ps
;
;
; MODIFICATION HISTORY:
;
;
;
;		 ; Written by: Kelle Cruz, Jan 2009
;;
; TO DO
; - add SpType Labels
; - make standards more prominent. 
;-

PRO TYPE_NIR, input_file, ps=ps,eps=eps, late=late

if N_params() lt 1 then begin
     print,"Syntax -  TYPE_NIR, 'Input_file_indices.sav',"
     print,"expects output from measure.pro"
     return
 endif

root='/scr2/kelle/nir_indices/plots/'

nir_path='/scr3/kelle/nir_spectra/2M_all/fits/'

;----------
; NIR SPEX PRISM Spectral Standards
;-----------

L0=KREADSPEC(nir_path+'2M0345.fits',hl0,/norm)
L1=KREADSPEC(nir_path+'2M2130_L1_kc.fits',h0602,/norm)
L2=KREADSPEC(nir_path+'spex_prism_kelu-1_060411.fits',hkelu1,/norm)
L3=KREADSPEC(nir_path+'u11291_050323.fits',h1506,/norm) ;1506+13
L4=KREADSPEC(nir_path+'U12101_2158-1550_davy.fits',h1155,/norm) ;2158-15
L5=KREADSPEC(nir_path+'spex_prism_sdss0835+19_chiu06.fits',hl5,/norm);0835
L6=KREADSPEC(nir_path+'U10880.fits',h0850,/norm) ;1010-04
L7=KREADSPEC(nir_path+'2M0103.fits',hl7,/norm) ;0103
L8=KREADSPEC(nir_path+'2M1632.fits',h0850,/norm) ;0257-31
L9=KREADSPEC(nir_path+'spex_prism_0255-4700_adam.fits',h0850,/norm)
;young=KREADSPEC(nir_path+'spex_prism_0141-4633_040905.fits',h0141,/norm)

;-----------

xsize=18.6267/1.45 ; 2 column wide 44 pica
ysize=xsize*1.5
scale=1.4
aspect_ratio=ysize/xsize

xsize_window=500 ;in pixels

@colors_kc ;load lots of colors

if keyword_set(ps) then begin
    ext='.ps'
endif else begin
    if keyword_set(eps) then begin
        ps = 1
        ext='.eps'
    endif else begin
         set_plot,'x'
         device, Decomposed=0   ;make colors work for 24-bit display
         black=white ;exchange colors to work with default black backround
         @symbols_kc
    endelse
endelse

;-----------

RESTORE, input_file
;input_file is output .sav file from measure.pro
;ref,desig,sp_type,spectra_files,indices,indices_sigma,index_name

n_objects=n_elements(ref)

FOR i=0,n_objects-1 DO BEGIN
    H2O_A07=indices[i,where(index_name eq 'H2O_A07')]
    H2OJ=indices[i,where(index_name eq 'H2OJ')]
    H2OH=indices[i,where(index_name eq 'H2OH')]
    ;CH4K=indices[i,where(index_name eq 'CH4K')]
    sH2OJ=indices[i,where(index_name eq 'sH2OJ')]

    ;Allers07
    spt_H2O_A07=(H2O_A07-0.77)/0.04
    ;Burgasser07
    spt_H2OJ=1.949e1 -3.919e1*H2OJ + 1.312e2*H2OJ^2 -2.156e2*H2OJ^3 + 1.038e2*H2OJ^4
    spt_H2OH=2.708e1 - 8.45e1 * H2OH + 2.424e2 * H2OH^2 - 3.381e2 * H2OH^3 + 1.491e2 * H2OH^4
    ;spt_CH4K=1.885e1 - 2.246e1* CH4K + 2.534e1 * CH4K^2 - 4.734 * CH4K^3 - 1.259e1 * CH4K^4
    ;Testi
    spt_sH2OJ=10*((1.54 * sH2OJ) + 0.98)
    
    spt_avg=mean([spt_H2O_A07,10+spt_H2OJ,10+spt_H2OH,spt_sH2OJ],/double)
    spt_stddev=STDDEV([spt_H2O_A07,10+spt_H2OJ,10+spt_H2OH,spt_sH2OJ],/double)

    if ref[i]-10000 lt 10000 then outfile_root='U'+strn(fix(ref[i]))+'_'+strmid(desig[i],0,4)+strmid(desig[i],7,5) else outfile_root='U'+strn(fix(ref[i]))+'_'+strmid(desig[i],0,4)+strmid(desig[i],8,5)
;U1 vs U2 desig length

IF KEYWORD_SET(ps) THEN BEGIN
    !p.font=0 
    set_plot, 'ps'
    device, filename=root+outfile_root+ext, encapsulated=keyword_set(eps), $
            /helvetica,/isolatin1,$
            landscape=0, color=1, xsize=xsize, ysize=ysize, scale=scale,$
            xoffset=1, yoffset=0.5
    @symbols_ps_kc
ENDIF ELSE BEGIN
    window, 0, xsize=xsize_window, ysize=xsize_window*aspect_ratio ,xpos=0,ypos=0
ENDELSE

!p.thick=1
!x.thick=3
!y.thick=3

o1=2.0 ; top of offset
ltop=o1+1.1
lbot=0.5

plot, [0],[0],/nodata, xr=[0.8,2.5],  yr=[0,o1+1.5], $
      xstyle=1, ystyle=1,xmargin=[6,3],$
      xtitle='Wavelength ('+micron+')', ytitle='Normalized Flux + Constant'

; character sizes
cs=STR_SIZE('2M 2213+19',0.20)
cs2=cs/2
;label locations
lo=0.4 ; label offset from data
xt=0.8 ; x location of label

xyouts, 2.4,ltop,outfile_root,align=1,charsize=cs

spec=KREADSPEC(nir_path+spectra_files[i],/norm)

oplot,L0[0,*],  L0[1,*]+o1, color=red,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L0', color=red

o1=o1-0.5
oplot,L1[0,*],  L1[1,*]+o1, color=purple,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L1', color=purple

o1=o1-0.5
oplot,L2[0,*],  L2[1,*]+o1, color=blue,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L2', color=blue

o1=o1-0.5
oplot,L3[0,*],  L3[1,*]+o1, color=dkgreen,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L3', color=dkgreen

o1=o1-0.5
oplot,L4[0,*],  L4[1,*]+o1, color=orange,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L4', color=orange

xyouts, 1,0.3,'SPT= '+strn(spt_avg,format='(f0.2)')+ 'pm' + strn(spt_stddev,format='(f0.2)')+'!C'+ $
        'sH2OJ: '+ strn(spt_sH2OJ)+'!C'+ $
        'H2OJ:'+ strn(10+spt_H2OJ)+'!C'+ $
        'A07: '+ strn(spt_H2O_A07)+'!C'+ $
        'H2OH: '+ strn(10+spt_H2OH),charsize=cs2

xyouts,1.5,0.2, 'Published SpT = '+strn(sp_type[i],format='(f0.1)'), charsize=cs2

;oplot,L0[0,*],  L0[1,*]+o1, color=purple
;xyouts, xt,o1+lo,'L0 Standard!C2M 0345',charsize=cs

;o1=o1-0.45
;oplot,U20076[0,*],  U20076[1,*]+o1, color=red
;xyouts, xt,o1+lo,'L0!C2M 0141-46!C'+sxpar(h76,'object') ,charsize=cs

;--------
;NIR/MICRONS FEATURE LABELS
;--------

tk1=1.4
tk2=0.85

;Na I
;    oplot, [8183,8183]/1e4,[0.65,23.5], linestyle =1
;    oplot, [8195,8195]/1e4,[0.65,23.5], linestyle =1
;    xyouts, 8190/1e4, ltop, 'Na !7I!X',align=0.5, charsize=cs2

;Li
;    oplot, [6708,6708]/1e4,[0,24], linestyle =1
;    xyouts, 6708/1e4, 11, 'Li !7I!X',align=0.5 , charsize=cs2

;VO
;    oplot,[7350., 7350,7370,7370]/1e4,[0,21,21,0], linestyle =1
;    oplot,[7550.,7550., 7570, 7570]/1e4,[0,21,21,0], linestyle =1
;    oplot,[7430.,7430., 7470, 7470]/1e4,[0,21,21,0], linestyle =1
;    xyouts, 7550, 22, 'VO-a',align=0.5, charsize=cs2
    
;    oplot,[7860., 7860,7880,7880]/1e4,[0,21,21,0], linestyle =1
;    oplot,[8080.,8080., 8100, 8100]/1e4,[0,21,21,0], linestyle =1
;    oplot,[7960.,7960., 8000, 8000]/1e4,[0,21,21,0], linestyle =1
;    xyouts, 8000, 22, 'VO-b',align=0.5, charsize=cs2

;K
;    oplot, [0.7665,0.7665],[1.05,1.15]+tk1, linestyle=1
;   oplot, [0.7699,0.7699],[1.05,1.15]+tk1, linestyle=1
;    xyouts, 0.76,1.17+tk1,'K !7I!X',align=0.5, charsize=cs2

;Na I
;        oplot, [8183,8183]/1e4,[lbot,ltop], linestyle =1
;        oplot, [8195,8195]/1e4,[lbot,ltop], linestyle =1
;        xyouts, 8190/1e4, ltop+lo, 'Na !7I!X',align=0.5, charsize=cs2

;TiO
    oplot, [0.8432,0.86],[1.05,1.05]+tk1 ;, linestyle=1
    oplot, [0.8432,0.8432],[1.00,1.05]+tk1
    xyouts, 0.84,1.08+tk1,'TiO', charsize=cs2,align=0

;CrH
    oplot, [0.8611,0.88],[1.25,1.25]+tk1 ;, linestyle=1
    oplot, [0.861,0.861],[1.20,1.25]+tk1
;oplot, [0.99,1.085],[2.0,2.0]+tk1, linestyle=1
    xyouts, 0.855,1.28+tk1,'CrH', charsize=cs2

;FeH
    oplot, [0.8692,0.89],[1.4,1.4]+tk1 ;, linestyle=1
    oplot, [0.8692,0.8692],[1.35,1.4]+tk1
;oplot, [0.99,1.085],[2.0,2.0]+tk1, linestyle=1
    xyouts, 0.865,1.43+tk1,'FeH',align=0.5, charsize=cs2

;Ca II triplet
;oplot, [8498,8498]/1e4,[1.0,1.95]+tk1, linestyle=1
;oplot, [8542,8542]/1e4,[1.0,1.95]+tk1, linestyle=1
;oplot, [8662,8662]/1e4,[1.0,1.95]+tk1, linestyle=1
;xyouts, 8490/1e4, 2.0+tk1, 'Ca !7II!X', charsize=cs2

;H20
    oplot, [0.91,0.95],[1.6,1.6]+tk1 ;, linestyle=1
    xyouts, 0.915, 1.65+tk1,'H2O', charsize=cs2
    
;FeH
    oplot, [0.986,0.99],[1.9,1.9]+tk1 ;, linestyle=1
    oplot, [0.986,0.986],[1.85,1.9]+tk1
    oplot, [0.99,1.085],[2.0,2.0]+tk1-0.1, linestyle=1
    xyouts, 0.985,2.05+tk1-0.1,'FeH',align=0.5, charsize=cs2
    
;VO
    oplot, [1.04,1.08],[1.75,1.75]+tk1 ;, linestyle=1
    xyouts, 1.06,1.80+tk1,'VO',align=0.5, charsize=cs2

;Na
    oplot, [1.138,1.138],[1.7,1.75]+tk1-0.1, linestyle=1
    oplot, [1.141,1.141],[1.7,1.75]+tk1-0.1, linestyle=1
    xyouts, 1.14,1.7+tk1,'Na !7I!X',align=1, charsize=cs2

;K
    oplot, [1.169,1.169],[1.7,1.85]+tk1-0.1, linestyle=1
    oplot, [1.178,1.178],[1.7,1.85]+tk1-0.1, linestyle=1
    ;oplot, [1.169,1.178],[ltop,ltop], linestyle=0
    xyouts, 1.17,1.87+tk1-0.1,'K !7I!X',align=0.5, charsize=cs2

;FeH
    oplot, [1.19,1.205],[2.0,2.0]+tk1-0.1 ;, linestyle=1
    oplot, [1.19,1.19],[1.95,2.0]+tk1-0.1
    xyouts, 1.185,2.05+tk1-0.1,'FeH', charsize=cs2

;FeH
    oplot, [1.24,1.27],[2.15,2.15]+tk1 ;, linestyle=1
    oplot, [1.24,1.24],[2.10,2.15]+tk1
    oplot, [1.27,1.33],[2.15,2.15]+tk1, linestyle=1
    ;xyouts, 1.23,2.20+tk1,'FeH', charsize=cs2

;K
    oplot, [1.243,1.243],[1.85,2.0]+tk1-0.25, linestyle=1
    oplot, [1.252,1.252],[1.85,2.0]+tk1-0.25, linestyle=1
    ;oplot, [1.244,1.253],[ltop,ltop], linestyle=0 ;K I     
    xyouts, 1.243,2.03+tk1-0.25,'K !7I!X',align=0, charsize=cs2

;PaB


;H2O
;    oplot, [1.3,1.51],[2.1,2.1]+tk1 ;, linestyle=1
;    xyouts, 1.38, 2.15+tk1,'H2O', charsize=cs2

;K
    oplot, [1.517,1.517],[1.35,1.5]+tk1, linestyle=1
    xyouts, 1.51,1.55+tk1,'K !7I!X',align=0.5, charsize=cs2

;FeH
    oplot, [1.59,1.75],[2.05,2.05]+tk2, linestyle=1
    xyouts, 1.65,2.1+tk2,'FeH', charsize=cs2

;H2O
;    oplot, [1.75,2.05],[1.85,1.85]+tk2 ;, linestyle=1
;    xyouts, 1.85, 1.9+tk2,'H2O', charsize=cs2

;Ca
    oplot, [1.93,1.99],[1.7,1.7]+tk2, linestyle=1
    xyouts, 1.94, 1.75+tk2,'Ca', charsize=cs2

;Na
    oplot, [2.206,2.206],[1.7,1.8]+tk2, linestyle=1
    oplot, [2.2089,2.2089],[1.7,1.8]+tk2, linestyle=1
    xyouts, 2.207, 1.83+tk2,'Na !7I!X',align=0.5, charsize=cs2
;CO
    oplot, [2.29,2.35],[1.65,1.65]+tk2 , linestyle=1
    oplot, [2.29,2.29],[1.60,1.65]+tk2 , linestyle=0
    xyouts, 2.3, 1.70+tk2,'CO', charsize=cs2

;H2O
;    oplot, [2.3,3.2],[1.8,1.8]+tk2 ;, linestyle=1
;    xyouts, 2.3, 1.85+tk2,'H2O', charsize=cs2



;-------------------

;
;if keyword_set(late) then begin
if ~keyword_set(ps) then window, 1, xsize=xsize_window, ysize=xsize_window*aspect_ratio,xpos=500,ypos=0

o1=2.0 ; top of offset
plot, [0],[0],/nodata, xr=[0.8,2.5],  yr=[0,o1+1.5], $
      xstyle=1, ystyle=1,xmargin=[6,3],$
      xtitle='Wavelength ('+micron+')', ytitle='Normalized Flux + Constant'

xyouts, 2.4,ltop,outfile_root,align=1,charsize=cs

oplot,L5[0,*],  L5[1,*]+o1, color=red,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L5', color=red

o1=o1-0.5
oplot,L6[0,*],  L6[1,*]+o1, color=purple,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L6', color=purple

o1=o1-0.5
oplot,L7[0,*],  L7[1,*]+o1, color=blue,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L7', color=blue

o1=o1-0.5
oplot,L8[0,*],  L8[1,*]+o1, color=dkgreen,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L8', color=dkgreen

o1=o1-0.5
oplot,L9[0,*],  L9[1,*]+o1, color=orange,linestyle=0,thick=2
oplot,spec[0,*], spec[1,*]+o1
xyouts, 2.4, o1+0.4,'L9', color=orange

;-------------------

;Ch4
    oplot, [1.1,1.24],[1.75,1.75]+tk1 ;, linestyle=1
    xyouts, 1.14,1.8+tk1,'CH4', charsize=cs2

 ;Ch4  
;    oplot, [1.6,1.8],[1.75,1.75]+tk1  ;, linestyle=1
;    xyouts, 1.67,1.8+tk1,'CH4', charsize=cs2

 ;Ch4
    oplot, [2.15,2.5],[1.4,1.4]+tk1 ;, linestyle=1
    xyouts, 2.3, 1.45+tk1,'CH4', charsize=cs2


;-------------------

;ENDIF ;late keyword

IF KEYWORD_SET(ps) THEN BEGIN
 device,/close
 set_plot,'x'
 !p.font=-1 ;go back to default (Vector Hershey fonts)
ENDIF ELSE BEGIN
    Print,'Press any key to continue.'
    tmp=get_kbrd()
ENDELSE

ENDFOR                           ;i over objects

!p.multi=0
loadct,0 ;go back to default greyscale color table

END

